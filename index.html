<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SuperFile — UI</title>
<style>
  :root{--bg:#0f1115;--card:#111217;--muted:#9aa0a6;--accent:#1f8ef1;--danger:#e74c3c;--ok:#2ecc71;--text:#eef2f5}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; background:var(--bg); color:var(--text)}
  .app{max-width:1000px;margin:12px auto;padding:14px;}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between}
  h1{font-size:1.1rem;margin:0}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{background:var(--card);color:var(--text);border:1px solid #222;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.primary{background:linear-gradient(90deg,var(--accent),#135ea6);border:none}
  input[type=text]{background:#0b0d10;border:1px solid #222;color:var(--text);padding:8px;border-radius:8px}
  .panel{background:var(--card);border-radius:12px;padding:10px;margin-top:12px;box-shadow:0 2px 8px rgba(0,0,0,0.6)}
  #pathBar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #fileList{margin:0;padding:0;list-style:none;max-height:52vh;overflow:auto}
  #fileList li{display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px solid #151719;cursor:pointer}
  #fileList li:hover{background:#0b1220}
  .meta{color:var(--muted);font-size:0.85rem;margin-left:auto}
  .actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .small{padding:6px 8px;font-size:0.9rem}
  .danger{background:linear-gradient(90deg,var(--danger),#a92b2b)}
  .ok{background:linear-gradient(90deg,var(--ok),#1b8a4f)}
  .footer{margin-top:12px;color:var(--muted);font-size:0.85rem}
  .search{display:flex;gap:8px}
  .badge{background:#0b1220;padding:4px 8px;border-radius:8px;font-size:0.85rem;color:var(--muted)}
  pre {white-space:pre-wrap;word-break:break-word}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1 id="title">SuperFile</h1>
    <div class="controls">
      <span class="badge" id="langBadge">EN</span>
      <button id="reqAll" class="small">Request Full Access</button>
      <button id="pickDir" class="small">Pick folder (SAF)</button>
    </div>
  </header>

  <div class="panel">
    <div id="pathBar">
      <input id="currentPath" type="text" placeholder="/storage/emulated/0" style="flex:1" />
      <button id="goPath" class="small">Go</button>
      <button id="up" class="small">Up</button>
      <button id="refresh" class="small">Refresh</button>
    </div>

    <div class="panel" style="margin-top:10px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="search" style="flex:1">
          <input id="searchInput" type="text" placeholder="Search or paste exact path (e.g. parham.patham)" />
          <button id="searchBtn" class="small">Search</button>
        </div>
        <div style="display:flex;gap:6px">
          <button id="newFile" class="small">New File</button>
          <button id="newFolder" class="small">New Folder</button>
          <button id="selectAll" class="small">Select All</button>
        </div>
      </div>

      <ul id="fileList"></ul>

      <div class="actions">
        <button id="copyBtn" class="small">Copy</button>
        <button id="cutBtn" class="small">Cut</button>
        <button id="pasteBtn" class="small ok">Paste</button>
        <button id="delBtn" class="small danger">Delete</button>
        <button id="renameBtn" class="small">Rename</button>
        <button id="zipBtn" class="small">Zip</button>
        <button id="unzipBtn" class="small">Unzip</button>
        <button id="openBtn" class="small">Open</button>
        <button id="installBtn" class="small">Install APK</button>
        <button id="dexViewBtn" class="small">View DEX</button>
        <button id="convertApksBtn" class="small">Convert APKS→APK</button>
        <button id="chmodBtn" class="small">Chmod (if allowed)</button>
      </div>
    </div>

    <div id="output" class="panel" style="margin-top:12px;max-height:220px;overflow:auto">
      <pre id="log">Ready.</pre>
    </div>

    <div class="footer">
      <div>Note: To actually perform heavy operations (install, read /data, convert apks) the hosting Android app must implement corresponding native methods and have required permissions. /data access typically requires root.</div>
    </div>
  </div>
</div>

<script>
/* ================= multi-language ================= */
const L = {
  en:{
    title:'SuperFile — Advanced',
    reqAll:'Request Full Access',
    pickDir:'Pick folder (SAF)',
    ready:'Ready.',
    notInApp:'This action works only inside the Android app.'
  },
  fa:{
    title:'سوپرفایل — پیشرفته',
    reqAll:'درخواست دسترسی کامل',
    pickDir:'انتخاب پوشه (SAF)',
    ready:'آماده.',
    notInApp:'این عملیات فقط در داخل اپ اندروید کار می‌کند.'
  }
};
const isFa = (navigator.language||'').startsWith('fa');
const STR = isFa?L.fa:L.en;
document.getElementById('title').textContent = STR.title;
document.getElementById('reqAll').textContent = STR.reqAll;
document.getElementById('pickDir').textContent = STR.pickDir;
document.getElementById('langBadge').textContent = isFa?'FA':'EN';
document.getElementById('log').textContent = STR.ready;

/* =============== helpers & Android bridge =============== */
function log(msg){
  const p = document.getElementById('log');
  const time = new Date().toLocaleTimeString();
  p.textContent = `[${time}] ${msg}\n` + p.textContent;
}
function inApp(){ return !!window.AndroidInterface; }

function safeCall(name, ...args){
  if(!inApp()){ alert(STR.notInApp); log('Native interface missing: '+name); return; }
  try{
    const fn = window.AndroidInterface[name];
    if(typeof fn === 'function'){
      // some WebView bridges expose functions differently (as methods on the object), but most use direct methods.
      fn.apply(window.AndroidInterface, args);
    } else {
      // try call as property (string-returning JSInterface)
      // convert args to single JSON string param
      if(window.AndroidInterface.postMessage){
        window.AndroidInterface.postMessage(JSON.stringify({cmd:name,args}));
      } else {
        // fallback: call as method by name if exists
        if(window.AndroidInterface[name] !== undefined){
          window.AndroidInterface[name](...args);
        } else {
          alert(STR.notInApp);
        }
      }
    }
  }catch(e){
    console.error(e);
    log('Error calling native '+name+': '+e);
  }
}

/* =============== UI actions =============== */
const listEl = document.getElementById('fileList');
let selectedPaths = new Set();
let currentPath = '';

function renderFiles(files){
  // files: [{name,path,isDirectory,size,modified}]
  listEl.innerHTML = '';
  files.forEach(f=>{
    const li = document.createElement('li');
    li.dataset.path = f.path;
    li.innerHTML = `<strong>${f.name}</strong> <span class="meta">${f.isDirectory?'/':' '}${f.size?f.size+' bytes':''} ${f.modified?(' • '+new Date(f.modified).toLocaleString()):''}</span>`;
    li.onclick = (ev)=>{
      if(ev.shiftKey || ev.ctrlKey){
        toggleSelect(f.path,li);
        return;
      }
      // single click -> open if file, enter if directory
      if(f.isDirectory){
        goToPath(f.path);
      } else {
        safeCall('openFile', f.path);
      }
    };
    li.oncontextmenu = (ev)=>{
      ev.preventDefault();
      toggleSelect(f.path,li);
    };
    listEl.appendChild(li);
  });
}

function toggleSelect(path, li){
  if(selectedPaths.has(path)){
    selectedPaths.delete(path); li.style.background='';
  } else {
    selectedPaths.add(path); li.style.background='#132133';
  }
  log('Selected: '+Array.from(selectedPaths).join(', '));
}

function goToPath(p){
  currentPath = p;
  document.getElementById('currentPath').value = p;
  if(inApp()){
    safeCall('listFiles', p); // native should call window.showFiles(json)
  } else {
    log(STR.notInApp);
  }
}

/* =============== buttons =============== */
document.getElementById('goPath').onclick = ()=>{ goToPath(document.getElementById('currentPath').value); };
document.getElementById('refresh').onclick = ()=>{ goToPath(currentPath||document.getElementById('currentPath').value); };
document.getElementById('up').onclick = ()=>{
  if(!currentPath) return;
  const up = currentPath.replace(/\/+$/,'').split('/').slice(0,-1).join('/') || '/';
  goToPath(up);
};
document.getElementById('pickDir').onclick = ()=> safeCall('pickFolder');
document.getElementById('reqAll').onclick = ()=> safeCall('requestManageAllFiles');
document.getElementById('searchBtn').onclick = ()=>{
  const q = document.getElementById('searchInput').value.trim();
  if(!q) return;
  // If path-like (contains / or .patham) attempt open
  if(q.includes('/') || q.includes('.')){
    safeCall('openPath', q);
  } else {
    safeCall('search', q);
  }
};
document.getElementById('newFile').onclick = ()=>{
  const name = prompt('New file name:')||'';
  if(!name) return;
  safeCall('createFile', currentPath||document.getElementById('currentPath').value, name);
};
document.getElementById('newFolder').onclick = ()=>{
  const name = prompt('New folder name:')||'';
  if(!name) return;
  safeCall('createFolder', currentPath||document.getElementById('currentPath').value, name);
};
document.getElementById('selectAll').onclick = ()=>{
  safeCall('selectAll', currentPath||document.getElementById('currentPath').value);
};
document.getElementById('copyBtn').onclick = ()=> safeCall('copySelected');
document.getElementById('cutBtn').onclick = ()=> safeCall('cutSelected');
document.getElementById('pasteBtn').onclick = ()=> safeCall('pasteClipboard');
document.getElementById('delBtn').onclick = ()=> {
  if(!confirm('Delete selected?')) return;
  safeCall('deleteSelected');
};
document.getElementById('renameBtn').onclick = ()=> {
  const path = prompt('Full path to rename (or select item):');
  if(!path) return;
  const name = prompt('New name:'); if(!name) return;
  safeCall('rename', path, name);
};
document.getElementById('zipBtn').onclick = ()=> {
  const dest = prompt('Zip output path (full):'); if(!dest) return;
  safeCall('zipSelected', dest);
};
document.getElementById('unzipBtn').onclick = ()=> {
  const dest = prompt('Unzip to folder (full path):'); if(!dest) return;
  safeCall('unzipSelected', dest);
};
document.getElementById('openBtn').onclick = ()=> safeCall('openSelected');
document.getElementById('installBtn').onclick = ()=> safeCall('installSelectedApk');
document.getElementById('dexViewBtn').onclick = ()=> safeCall('viewDexSelected');
document.getElementById('convertApksBtn').onclick = ()=> safeCall('convertApksToApk');
document.getElementById('chmodBtn').onclick = ()=> {
  const mode = prompt('chmod mode (e.g. 755):'); if(!mode) return;
  safeCall('chmodSelected', mode);
};

/* =============== callbacks from native =============== */
/*
 Native (Kotlin) should call these global functions via:
 webView.evaluateJavascript("showFiles("+jsonString+")", null);
 or via addJavascriptInterface with methods that call these functions
*/
function showFiles(json){
  // json is either object or string
  try{
    const arr = typeof json === 'string' ? JSON.parse(json) : json;
    renderFiles(arr);
    log('Listed '+arr.length+' items in '+(arr[0] && arr[0].parent?arr[0].parent:document.getElementById('currentPath').value));
  }catch(e){
    log('showFiles parse error: '+e);
  }
}
function showMessage(msg){
  log(msg);
  // also toast via native if available
  if(inApp()) safeCall('toast', msg);
}
function setCurrentPath(p){
  currentPath = p;
  document.getElementById('currentPath').value = p;
}
function setSelected(pathsJson){
  try{
    const arr = typeof pathsJson === 'string' ? JSON.parse(pathsJson) : pathsJson;
    selectedPaths = new Set(arr);
    log('Selected set from native. Count='+selectedPaths.size);
  }catch(e){ log('setSelected parse err: '+e); }
}

/* =============== auto-enter root on load if provided =============== */
window.addEventListener('load', ()=>{
  // If hosting app injects initialPath, it can call setCurrentPath(...)
  // otherwise user will press Pick Folder or Request Full Access
});
</script>
</body>
</html>
